---
title: "Clasificaci√≥n Bosque/No-Bosque"
subtitle: "Proyecto de Miner√≠a de Datos con Sentinel-2 y AWS"
author: "Equipo del proyecto"
date: "2025-11-12"
format:
  revealjs:
    theme: [default]
    slide-number: true
    toc: false
    incremental: true
    code-copy: true
    footer: "Proyecto Miner√≠a de Datos ¬∑ AWS EC2/EMR ¬∑ Sentinel-2"
    embed-resources: true
    smaller: true
    mermaid:
      theme: default
execute:
  echo: false
  warning: false
lang: es
---

## Introducci√≥n

La deforestaci√≥n en Colombia responde principalmente a la expansi√≥n de la frontera agr√≠cola (tanto por usos legales como ilegales del suelo) y a actividades intensivas de aprovechamiento forestal con fines comerciales y dom√©sticos [1]. Dado el car√°cter altamente diverso del pa√≠s, las regiones presentan condiciones biof√≠sicas y din√°micas socioambientales diferenciadas; por ello, el estudio de la deforestaci√≥n a escala subnacional o subregional es clave para producir diagn√≥sticos m√°s precisos y acciones de manejo focalizadas.

En este contexto, las im√°genes satelitales, combinadas con sistemas de informaci√≥n geogr√°fica, se han consolidado como insumos fundamentales para el mapeo y la anal√≠tica espacial en ciencia e industria. En ecolog√≠a forestal, los m√©todos de aprendizaje de m√°quina permiten abordar tareas como la identificaci√≥n de coberturas, la modelaci√≥n de distribuci√≥n de especies, la estimaci√≥n de ciclos de carbono, la gesti√≥n del riesgo y el pron√≥stico. Un insumo cr√≠tico para m√∫ltiples aplicaciones es la delimitaci√≥n confiable de √°reas forestales en una regi√≥n dada, informaci√≥n que puede derivarse de sensores como Sentinel‚Äë2 mediante flujos de datos reproducibles y escalables.

---

## Pregunta y Objetivo general

### Pregunta de investigaci√≥n

¬øQu√© tan bien puede un modelo de ML basado en variables espectrales de Sentinel-2 diferenciar Bosque de No-Bosque en el √°rea de estudio, bajo un flujo reproducible de datos en AWS?

### Objetivo general

Construir y evaluar un pipeline de punta a punta para clasificar Bosque/No-Bosque usando Sentinel-2, con preprocesamiento robusto, etiquetado confiable, entrenamiento en Spark (EMR) y evaluaci√≥n con m√©tricas por clase.

---

## Objetivos espec√≠ficos

- Dise√±ar el flujo de preprocesamiento y control de calidad (nubes, sombras, nieve).
- Generar etiquetas raster (1=bosque, 0=no-bosque, -1=ignorar) a partir de shapes confiables.
- Tabular features espectrales y temporales y construir el dataset de entrenamiento.
- Entrenar modelos en Spark (Random Forest, GBT) y seleccionar el de mejor desempe√±o.
- Evaluar con m√©tricas por clase (precisi√≥n, recall, F1), matriz de confusi√≥n y reporte.
- Orquestar la ejecuci√≥n en AWS y versionar artefactos en S3 para reproducibilidad.

---

## Datos y caracter√≠sticas

- Sentinel-2: bandas B01-B12; √≠ndices: NDVI, NDWI.
- Reproyecci√≥n objetivo: EPSG:4326; resoluci√≥n t√≠pica: 20 m.
- Composici√≥n temporal (p.ej., median, p10, p90, rango) por banda/√≠ndice.

---

## Metodolog√≠a (visi√≥n general)

0) Ingesta de datos (shapes + historial Sentinel-2)  
1) Preprocesamiento im√°genes (Sentinel-2)  
2) M√°scaras Clear-Sky (nubes, sombras, nieve)  
3) Tabulaci√≥n de features v√°lidas  
4) Rasterizaci√≥n de etiquetas (bosque/no-bosque)  
5) Uni√≥n features + labels (dataset)  
6) Entrenamiento modelos en Spark (EMR)  
7) Evaluaci√≥n y reporte de m√©tricas

---

## Ingesta de datos (workflow.pdf p. 3)

Dos componentes principales:

1) Subida de shapes a S3  
   - Carga de los shapefiles del √°rea/fin cas objetivo y/o listado de im√°genes objetivo.  
   - Organizaci√≥n en el bucket para referencia por los scripts posteriores.  
   - Ejemplo de estructura:  
     - `s3://<bucket>/shapes/`  
     - `s3://<bucket>/lists/imagenes_objetivo.csv`

2) Descarga de datos Sentinel-2  
   - A partir de la definici√≥n anterior, b√∫squeda de las im√°genes objetivo y descarga de su hist√≥rico.  
   - Se almacenan los productos originales en formato `.SAFE` en S3.  
   - Ruta sugerida: `s3://<bucket>/raw/raw_copernicus/<finca>/.../*.SAFE/`

Notas:
- Esta etapa prepara el ‚Äúraw zone‚Äù del data lake en S3 para el preprocesamiento (01-05).  
- El etiquetado y entrenamiento dependen de que esta ingesta est√© completa y consistente.

---

## Metodolog√≠a (diagrama de flujo)

<!-- Aumentar tama√±o del diagrama en Reveal.js -->
<style>
.reveal .slides .mermaid svg { width: 100% !important; height: 78vh !important; }
.reveal .slides .mermaid { margin: 0 auto; }
</style>

```{mermaid}
%%{init: {'flowchart': {'curve':'basis','rankSpacing':90,'nodeSpacing':60}, 'themeVariables': {'fontSize': '18px'}} }%%
flowchart LR

%% ======== SECCIONES PRINCIPALES ========
subgraph LOCAL["üíª Entorno Local"]
    L1["1Ô∏è‚É£ Subida de shapes a S3
    - Carga shapefiles y/o listas de im√°genes objetivo
    - Organizaci√≥n en:
      s3://<bucket>/shapes/
      s3://<bucket>/lists/imagenes_objetivo.csv"]
    
    L2["2Ô∏è‚É£ Descarga de datos Sentinel-2
    - B√∫squeda y descarga hist√≥rica de im√°genes
    - Almacenamiento .SAFE en:
      s3://<bucket>/raw/raw_copernicus/<finca>/*.SAFE/"]

    L1 --> L2
end

%% Puerta de entrada a AWS
ENTRY_AWS["üö™ Ingreso a AWS"]

L2 -->|Carga datos raw a S3| ENTRY_AWS

%% ======== AWS INFRAESTRUCTURA ========
subgraph AWS["‚òÅÔ∏è AWS Infraestructura"]
direction LR

  %% EC2 Preprocesamiento
  subgraph EC2["üñ•Ô∏è EC2 - Preprocesamiento"]
    A3["3Ô∏è‚É£ 01_procesar_sentinel.py
    - Procesa bandas e √≠ndices
    - Reproyecci√≥n al CRS objetivo"]

    A4["4Ô∏è‚É£ 02_generar_mascaras.py
    - M√°scaras cielo despejado
    - NDVI/NIR y dilataci√≥n"]

    A5["5Ô∏è‚É£ 03_tabular_features.py
    - Extrae p√≠xeles v√°lidos
    - Estad√≠sticas temporales"]

    A6["6Ô∏è‚É£ 04_rasterizar_labels.py
    - Rasteriza bosque desde shapes
    - Erosi√≥n morfol√≥gica"]

    A7["7Ô∏è‚É£ 05_unir_features_labels.py
    - Dataset con features y labels"]

    A3 --> A4 --> A5 --> A6 --> A7
  end

  %% EMR Entrenamiento
  subgraph EMR["üî• EMR - Entrenamiento y Evaluaci√≥n"]
    A8["8Ô∏è‚É£ 06_entrenar_modelos_spark.py
    - Entrena RandomForest o GBT en Spark (EMR)"]

    A9["9Ô∏è‚É£ 07_evaluar_modelos.py
    - Calcula m√©tricas y genera reporte"]

    A8 --> A9
  end
end

%% Puerta de salida a S3
EXIT_AWS["üö™ Salida hacia S3"]

ENTRY_AWS --> A3
A7 -->|Dataset final a S3: features y labels| A8
A9 --> EXIT_AWS
EXIT_AWS -->|Modelos y m√©tricas| S3

%% ======== S3 HUB ========
S3["üóÑÔ∏è Amazon S3
Zonas: raw, procesados, features, labels, modelos, resultados"]

%% ======== ESTILOS ========
style LOCAL fill:#d6eaff,stroke:#007bff,stroke-width:2px
style AWS fill:#fff3cd,stroke:#ffb400,stroke-width:2px
style EC2 fill:#e8ffe8,stroke:#2ca02c,stroke-width:1.5px
style EMR fill:#ffe8e8,stroke:#ff0000,stroke-width:1.5px
style S3 fill:#f0f0f0,stroke:#666,stroke-width:1.5px
style ENTRY_AWS fill:#ffffff,stroke:#999,stroke-dasharray:3 3
style EXIT_AWS fill:#ffffff,stroke:#999,stroke-dasharray:3 3
```

---

## Metodolog√≠a (scripts del repositorio)

- `scripts/01_procesar_sentinel.py`: procesa bandas e √≠ndices; reproyecci√≥n al CRS objetivo.
- `scripts/02_generar_mascaras.py`: m√°scaras de cielo despejado; heur√≠sticas NDVI/NIR; dilataci√≥n.
- `scripts/03_tabular_features.py`: extrae p√≠xeles v√°lidos y compone estad√≠sticas temporales.
- `scripts/04_rasterizar_labels.py`: rasteriza bosque desde shapes; aplica erosi√≥n morfol√≥gica.
- `scripts/05_unir_features_labels.py`: construye dataset (features + labels, coords x,y).
- `scripts/06_entrenar_modelos_spark.py`: entrena RandomForest/GBT en EMR Spark.
- `scripts/07_evaluar_modelos.py`: calcula y reporta m√©tricas de clasificaci√≥n.

---

## Infraestructura y orquestaci√≥n

- EC2 para preprocesamiento (scripts 01‚Äì05).  
- EMR para entrenamiento/evaluaci√≥n (scripts 06‚Äì07).  
- S3 para entrada/salida: raw, procesados, features, labels, modelos, resultados.  
- Par√°metros en `config/*.yaml` y gu√≠as en `EXECUTION_GUIDE.md`.

---

## Ejecuci√≥n (resumen)

En EC2 (preprocesamiento):

```bash
python scripts/orchestration/run_ec2_pipeline.py --mode sequential
# o bien: --script 01_procesar_sentinel (etc.)
```

En local para lanzar EMR (ML):

```bash
python scripts/orchestration/run_emr_pipeline.py \
  --script 06_entrenar_modelos_spark \
  --create-cluster --auto-terminate
```

---

## Resultados: m√©tricas objetivo

- Exactitud (accuracy) global.  
- Precision y Recall por clase (0=No‚ÄëBosque, 1=Bosque).  
- F1 por clase y macro/micro promedio.  
- Matriz de confusi√≥n y reporte interpretativo.

Criterios de √©xito sugeridos:

- Recall clase Bosque (1) ‚â• 0.85  
- F1 clase Bosque (1) ‚â• 0.85  
- Balance razonable precisi√≥n/recall (sin sesgo fuerte por clase)

---

## Resultados (interpretaci√≥n)

- Si el recall de Bosque es bajo ‚Üí aumentar `class_weight`, ajustar umbral o erosi√≥n.  
- Si hay muchos falsos positivos ‚Üí revisar umbrales y features temporales.  
- Usar el reporte de `scripts/07_evaluar_modelos.py` para recomendaciones.

> Nota: Inserta aqu√≠ las m√©tricas reales una vez ejecutado el pipeline y exportado el reporte de evaluaci√≥n.

---

## Conclusiones

- El pipeline soporta un flujo reproducible y escalable en AWS.  
- La evaluaci√≥n por clase asegura que el objetivo (bosque/no‚Äëbosque) sea verificable.  
- Pr√≥ximos pasos: pruebas con datos reales, ajuste fino y validaci√≥n espacial.

---

## Referencias y gu√≠as

- [1] Estudios sobre causas de deforestaci√≥n en Colombia (s√≠ntesis; indicar fuente y a√±o exacto en la versi√≥n final).  
- `README.md`, `EXECUTION_GUIDE.md`, `RESUMEN_EJECUTIVO.md`  
- Configuraci√≥n: `config/*.yaml`  
- Orquestaci√≥n: `scripts/orchestration/*`
