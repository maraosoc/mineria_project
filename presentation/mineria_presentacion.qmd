---
title: "Detección de Deforestación con Machine Learning"
subtitle: "Pipeline de Clasificación Bosque/No-Bosque usando Sentinel-2 y AWS"
author: "Equipo de Minería de Datos"
date: "12 de noviembre de 2025"
format:
  revealjs:
    theme: [default, custom.scss]
    slide-number: true
    toc: false
    incremental: false
    code-copy: true
    footer: "Proyecto Minería de Datos · AWS · Sentinel-2 · Machine Learning"
    embed-resources: true
    mermaid:
      theme: forest
    width: 1920
    height: 1080
    margin: 0.1
    transition: slide
    background-transition: fade
execute:
  echo: false
  warning: false
lang: es
---

## IntroducciÃ³n

La deforestaciÃ³n en Colombia responde principalmente a la expansiÃ³n de la frontera agrÃ­cola (tanto por usos legales como ilegales del suelo) y a actividades intensivas de aprovechamiento forestal con fines comerciales y domÃ©sticos [1]. Dado el carÃ¡cter altamente diverso del paÃ­s, las regiones presentan condiciones biofÃ­sicas y dinÃ¡micas socioambientales diferenciadas; por ello, el estudio de la deforestaciÃ³n a escala subnacional o subregional es clave para producir diagnÃ³sticos mÃ¡s precisos y acciones de manejo focalizadas.


---

## IntroducciÃ³n (herramientas)

En este contexto, las imÃ¡genes satelitales, combinadas con sistemas de informaciÃ³n geogrÃ¡fica, se han consolidado como insumos fundamentales para el mapeo y la analÃ­tica espacial en ciencia e industria. En ecologÃ­a forestal, los mÃ©todos de aprendizaje de mÃ¡quina permiten abordar tareas como la identificaciÃ³n de coberturas, la modelaciÃ³n de distribuciÃ³n de especies, la estimaciÃ³n de ciclos de carbono, la gestiÃ³n del riesgo y el pronÃ³stico. Un insumo crÃ­tico para mÃºltiples aplicaciones es la delimitaciÃ³n confiable de Ã¡reas forestales en una regiÃ³n dada, informaciÃ³n que puede derivarse de sensores como Sentinelâ€‘2 mediante flujos de datos reproducibles y escalables.

---

## Pregunta y Objetivo general

### Pregunta de investigaciÃ³n

Â¿QuÃ© tan bien puede un modelo de ML basado en variables espectrales de Sentinel-2 diferenciar Bosque de No-Bosque en el Ã¡rea de estudio, bajo un flujo reproducible de datos en AWS?

### Objetivo general

Construir y evaluar un pipeline de punta a punta para clasificar Bosque/No-Bosque usando Sentinel-2, con preprocesamiento robusto, etiquetado confiable, entrenamiento en Spark (EMR) y evaluaciÃ³n con mÃ©tricas por clase.

---

## Objetivos específicos

- Implementar un pipeline de ingesta eficiente de datos satelitales multiespectrales en zonas rurales.
- Generar un conjunto de grandes volúmenes de datos limpios de artefactos con características relevantes.
- Diseñar modelos de aprendizaje automático capaces de detectar bosque / no-bosque.
- Optimizar el entrenamiento y validación de los modelos para grandes volúmenes de datos.

---
## Datos y caracterÃ­sticas

- Sentinel-2: bandas B01-B12; Ã­ndices: NDVI, NDWI.
- ReproyecciÃ³n objetivo: EPSG:4326; resoluciÃ³n tÃ­pica: 20 m.
- ComposiciÃ³n temporal (p.ej., median, p10, p90, rango) por banda/Ã­ndice.

---

## MetodologÃ­a (visiÃ³n general)

0) Ingesta de datos (shapes + historial Sentinel-2)  
1) Preprocesamiento imÃ¡genes (Sentinel-2)  
2) MÃ¡scaras Clear-Sky (nubes, sombras, nieve)  
3) TabulaciÃ³n de features vÃ¡lidas  
4) RasterizaciÃ³n de etiquetas (bosque/no-bosque)  
5) UniÃ³n features + labels (dataset)  
6) Entrenamiento modelos en Spark (EMR)  
7) EvaluaciÃ³n y reporte de mÃ©tricas

---

## Ingesta de datos 

Dos componentes principales:

1) Subida de shapes a S3  
   - Carga de los shapefiles del Ã¡rea/fin cas objetivo y/o listado de imÃ¡genes objetivo.  
   - OrganizaciÃ³n en el bucket para referencia por los scripts posteriores.  
   - Ejemplo de estructura:  
     - `s3://<bucket>/shapes/`  
     - `s3://<bucket>/lists/imagenes_objetivo.csv`

2) Descarga de datos Sentinel-2  
   - A partir de la definiciÃ³n anterior, bÃºsqueda de las imÃ¡genes objetivo y descarga de su histÃ³rico.  
   - Se almacenan los productos originales en formato `.SAFE` en S3.  
   - Ruta sugerida: `s3://<bucket>/raw/raw_copernicus/<finca>/.../*.SAFE/`

Notas:
- Esta etapa prepara el â€œraw zoneâ€ del data lake en S3 para el preprocesamiento (01-05).  
- El etiquetado y entrenamiento dependen de que esta ingesta estÃ© completa y consistente.

---

## PreparaciÃ³n de datos (DATA_PREP.md)

- Dataset final consolidado: `s3://mineria-project/data/all/training_data_all_zones.parquet` (8,008 muestras; 15 features).

Paso 1 Â· Procesar Sentinel-2 (clip)
- Script: `01_procesar_sentinel_clip.py`
- Entrada: `raw/raw_copernicus/ZONA/*.SAFE`, perÃ­metros `raw/shapes/ZONA/PerÃ­metro.shp`
- Salida: `staging/01_rasters_procesados_clipped/ZONA/` (GeoTIFF multibanda, 10 bandas, 10 m, EPSG:4326)

Paso 2 Â· Tabular features espectrales
- Script: `03_tabular_features.py`
- ExtracciÃ³n pixel a pixel, composiciÃ³n temporal (mediana, p25, p75), `n_obs`
- Salida: `composite_annual.parquet`, `observations_all.parquet` (Polars/Parquet)

Paso 3 Â· Rasterizar etiquetas (labels)
- Script: `04_rasterizar_labels.py`
- ErosiÃ³n morfolÃ³gica de bordes; clases: 1=bosque, 0=no-bosque, -1=ignorar
- Salida: `forest_labels.tif`

Paso 4 Â· Unir features + labels
- Script: `05_unir_features_labels.py`
- Une medianas/percentiles + label por (x,y); filtra `label=-1`
- Salida: `training_data.parquet` (18 columnas: 15 features + metadata)

Paso 5 Â· ConsolidaciÃ³n multi-zona
- Script: `process_all_zones_pipeline.py`
- Descubre zonas, valida insumos, concatena, aÃ±ade `zone`, genera reporte
- Salida: `training_data_all_zones.parquet` + `pipeline_report_*.json`

Resumen del dataset (ejemplo reciente)
- Total: 8,008 pÃ­xeles; Bosque=22.7%, No-Bosque=77.3% (ratio â‰ˆ 3.4:1)
- Zonas procesadas: 5 de 6; duraciÃ³n total ~65s

---

## DATA_PREP â€” Resumen

- Objetivo: preparar datos Sentinel-2 para detecciÃ³n de deforestaciÃ³n con ML.  
- Cobertura: 6 zonas (5 procesadas correctamente, 1 con error por cobertura/CRS).  
- Salida final consolidada: `s3://mineria-project/data/all/training_data_all_zones.parquet`.
- Pasos del pipeline:
  - Paso 1: `01_procesar_sentinel_clip.py` â†’ rasters multibanda (10 m, EPSG:4326, clipping + mÃ¡scara SCL).
  - Paso 2: `03_tabular_features.py` â†’ extracciÃ³n pixel a pixel y composiciÃ³n temporal (mediana, p25, p75, n_obs).
  - Paso 3: `04_rasterizar_labels.py` â†’ labels 1/0/-1 con erosiÃ³n morfolÃ³gica en bordes de bosque.
  - Paso 4: `05_unir_features_labels.py` â†’ une features + label por (x,y); filtra `label=-1`.
  - Paso 5: `process_all_zones_pipeline.py` â†’ consolida por zonas y genera reporte.

---

## DATA_PREP â€” EstadÃ­sticas

- Archivo: `s3://mineria-project/data/all/training_data_all_zones.parquet`
- Total de muestras: 8,008 pÃ­xeles  
- Clase Bosque (1): 1,820 (22.7%)  
- Clase No-Bosque (0): 6,188 (77.3%)  
- Ratio global: 3.40:1  
- Features: 15 espectrales (medianas + percentiles)  
- Zonas procesadas: 5 de 6  
- DuraciÃ³n total: 64.7 s  
- Fecha de generaciÃ³n: 2025-11-12 16:36:53

Notas por zonas (resumen):
- Zona 29 (principal) y Zona 32: mejor balance de clases.  
- Zona 79: extremadamente desbalanceada (casi sin bosque) â†’ considerar excluir.  
- Zona 42: sin pÃ­xeles vÃ¡lidos â†’ requiere reprocesamiento o descarte.

---

## MetodologÃ­a (diagrama de flujo)

<div style="display:flex; align-items:center; justify-content:center; height:80vh; width:100%; margin-top:2vh;">
  <img src="C:/Users/jmox0/Documents/mermaid.png" alt="Diagrama de flujo de la metodologÃ­a" style="max-height:80vh; max-width:100%; height:auto; width:auto; object-fit:contain;" />
</div>

---

## MetodologÃ­a (scripts del repositorio)

- `scripts/01_procesar_sentinel.py`: procesa bandas e Ã­ndices; reproyecciÃ³n al CRS objetivo.
- `scripts/02_generar_mascaras.py`: mÃ¡scaras de cielo despejado; heurÃ­sticas NDVI/NIR; dilataciÃ³n.
- `scripts/03_tabular_features.py`: extrae pÃ­xeles vÃ¡lidos y compone estadÃ­sticas temporales.
- `scripts/04_rasterizar_labels.py`: rasteriza bosque desde shapes; aplica erosiÃ³n morfolÃ³gica.
- `scripts/05_unir_features_labels.py`: construye dataset (features + labels, coords x,y).
- `scripts/06_entrenar_modelos_spark.py`: entrena RandomForest/GBT en EMR Spark.
- `scripts/07_evaluar_modelos.py`: calcula y reporta mÃ©tricas de clasificaciÃ³n.

---

## Infraestructura y orquestaciÃ³n

- EC2 para preprocesamiento (scripts 01â€“05).  
- EMR para entrenamiento/evaluaciÃ³n (scripts 06â€“07).  
- S3 para entrada/salida: raw, procesados, features, labels, modelos, resultados.  
- ParÃ¡metros en `config/*.yaml` y guÃ­as en `EXECUTION_GUIDE.md`.

---

## EjecuciÃ³n (resumen)

En EC2 (preprocesamiento):

```bash
python scripts/orchestration/run_ec2_pipeline.py --mode sequential
# o bien: --script 01_procesar_sentinel (etc.)
```

En local para lanzar EMR (ML):

```bash
python scripts/orchestration/run_emr_pipeline.py \
  --script 06_entrenar_modelos_spark \
  --create-cluster --auto-terminate
```

---

## Resultados: mÃ©tricas objetivo

- Exactitud (accuracy) global.  
- Precision y Recall por clase (0=Noâ€‘Bosque, 1=Bosque).  
- F1 por clase y macro/micro promedio.  
- Matriz de confusiÃ³n y reporte interpretativo.

Criterios de Ã©xito sugeridos:

- Recall clase Bosque (1) â‰¥ 0.85  
- F1 clase Bosque (1) â‰¥ 0.85  
- Balance razonable precisiÃ³n/recall (sin sesgo fuerte por clase)

---

## Resultados (interpretaciÃ³n)

- Si el recall de Bosque es bajo â†’ aumentar `class_weight`, ajustar umbral o erosiÃ³n.  
- Si hay muchos falsos positivos â†’ revisar umbrales y features temporales.  
- Usar el reporte de `scripts/07_evaluar_modelos.py` para recomendaciones.



---

## Conclusiones

- El pipeline soporta un flujo reproducible y escalable en AWS.  
- La evaluaciÃ³n por clase asegura que el objetivo (bosque/noâ€‘bosque) sea verificable.  
- PrÃ³ximos pasos: pruebas con datos reales, ajuste fino y validaciÃ³n espacial.

---

## Referencias y guÃ­as

- [1] Estudios sobre causas de deforestaciÃ³n en Colombia (sÃ­ntesis; indicar fuente y aÃ±o exacto en la versiÃ³n final).  
- `README.md`, `EXECUTION_GUIDE.md`, `RESUMEN_EJECUTIVO.md`  
- ConfiguraciÃ³n: `config/*.yaml`  
- OrquestaciÃ³n: `scripts/orchestration/*`

